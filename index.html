ÔøΩÔøΩ< <!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Discussion UI</title>
    <style>
      /* Reset & c∆° b·∫£n */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f0f2f5;
      }

      header {
        background-color: #4267b2;
        color: #fff;
        padding: 10px 20px;
      }

      h1 {
        font-size: 24px;
      }

      .container {
        display: flex;
        height: calc(100vh - 50px);
      }

      /* Sidebar ch·ª©a danh s√°ch ch·ªß ƒë·ªÅ */
      .sidebar {
        width: 300px;
        background: #fff;
        border-right: 1px solid #ccc;
        padding: 10px;
        overflow-y: auto;
      }

      .sidebar h3 {
        margin-bottom: 10px;
      }

      .thread {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }

      .thread:hover {
        background-color: #f0f0f0;
      }

      .active-thread {
        background-color: #e9ecef;
      }

      .new-thread {
        margin-top: 15px;
        padding: 10px;
        border-top: 1px solid #ccc;
      }

      .new-thread input,
      .new-thread textarea,
      .new-thread select {
        width: 100%;
        margin-bottom: 5px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
      }

      .new-thread button {
        width: 100%;
        background-color: #4267b2;
        color: #fff;
        border: none;
        padding: 8px;
        border-radius: 3px;
        cursor: pointer;
      }

      .new-thread button:hover {
        background-color: #365899;
      }

      /* Khu v·ª±c hi·ªÉn th·ªã b√¨nh lu·∫≠n */
      .discussion-area {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .discussion-area h2 {
        margin-bottom: 15px;
      }

      .post {
        background: #fff;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .post .author {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .post .content {
        margin-bottom: 5px;
      }

      .post .timestamp {
        font-size: 12px;
        color: gray;
      }

      .post .actions {
        margin-top: 8px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .post .like-btn {
        background: none;
        border: none;
        color: #4267b2;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .post .like-btn.liked {
        color: #e41e3f;
      }

      .post .like-count {
        color: #65676b;
        font-size: 13px;
      }

      .post .reply-btn {
        background: none;
        border: none;
        color: #4267b2;
        cursor: pointer;
      }

      .replies {
        margin-left: 20px;
        margin-top: 10px;
      }

      .reply-form {
        margin-top: 8px;
        display: none;
      }

      .reply-form textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        resize: vertical;
        margin-bottom: 5px;
      }

      .reply-form button {
        background-color: #4267b2;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 3px;
        cursor: pointer;
      }

      .pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .pagination button {
        padding: 5px 10px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }

      .pagination button:disabled {
        background: #f0f0f0;
        cursor: not-allowed;
      }

      .rating-input {
        width: 60px !important;
        display: inline-block !important;
        margin-left: 10px;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Discussion</h1>
    </header>
    <div class="container">
      <div class="sidebar">
        <h3>Ch·ªß ƒë·ªÅ</h3>
        <div id="thread-list">
          <p>ƒêang t·∫£i...</p>
        </div>
        <div class="new-thread">
          <h4>T·∫°o ch·ªß ƒë·ªÅ m·ªõi</h4>
          <select id="thread-type">
            <option value="LESSON_DISCUSSION">Th·∫£o lu·∫≠n b√†i h·ªçc</option>
            <option value="COURSE_REVIEW">ƒê√°nh gi√° kh√≥a h·ªçc</option>
          </select>
          <input type="text" id="course-id" placeholder="ID kh√≥a h·ªçc" />
          <input type="text" id="lesson-id" placeholder="ID b√†i h·ªçc" />
          <input
            type="text"
            id="new-thread-title"
            placeholder="Ti√™u ƒë·ªÅ ch·ªß ƒë·ªÅ"
          />
          <textarea
            id="new-thread-content"
            rows="3"
            placeholder="N·ªôi dung ban ƒë·∫ßu"
          ></textarea>
          <input
            type="number"
            id="initial-rating"
            class="rating-input"
            placeholder="ƒê√°nh gi√° (1-5)"
            min="1"
            max="5"
          />
          <button id="create-thread-btn">T·∫°o ch·ªß ƒë·ªÅ</button>
        </div>
      </div>
      <div class="discussion-area">
        <h2 id="thread-title">Ch·ªçn ch·ªß ƒë·ªÅ ƒë·ªÉ xem b√¨nh lu·∫≠n</h2>
        <div id="post-list"></div>
        <div class="pagination">
          <button id="prev-page" disabled>Trang tr∆∞·ªõc</button>
          <span id="page-info">Trang 1</span>
          <button id="next-page">Trang sau</button>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL = 'http://localhost:3000/api/v1';
      let currentThreadId = null;
      let currentPage = 1;
      const POSTS_PER_PAGE = 10;
      const MOCK_USER_ID = 'user-123'; // Thay th·∫ø b·∫±ng user ID th·ª±c khi c√≥ auth

      // H√†m l·∫•y danh s√°ch ch·ªß ƒë·ªÅ
      async function fetchThreads() {
        const type = document.getElementById('thread-type').value;
        const courseId = document.getElementById('course-id').value;
        const lessonId = document.getElementById('lesson-id').value;

        try {
          const queryParams = new URLSearchParams({
            type,
            ...(courseId && { courseId }),
            ...(lessonId && { lessonId }),
            page: '1',
            limit: '20',
          });

          const response = await fetch(`${BASE_URL}/threads?${queryParams}`);
          if (!response.ok) throw new Error('L·ªói khi l·∫•y danh s√°ch ch·ªß ƒë·ªÅ');

          const data = await response.json();
          renderThreadList(data.threads);
        } catch (error) {
          console.error(error);
          document.getElementById('thread-list').innerHTML =
            '<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c ch·ªß ƒë·ªÅ.</p>';
        }
      }

      // Render danh s√°ch ch·ªß ƒë·ªÅ
      function renderThreadList(threads) {
        const threadListDiv = document.getElementById('thread-list');
        threadListDiv.innerHTML = '';

        if (!threads || threads.length === 0) {
          threadListDiv.innerHTML = '<p>Kh√¥ng c√≥ ch·ªß ƒë·ªÅ n√†o.</p>';
          return;
        }

        threads.forEach((thread) => {
          const div = document.createElement('div');
          div.className = 'thread';
          // Hi·ªÉn th·ªã th√™m th√¥ng tin v·ªÅ thread
          div.innerHTML = `
            <div><strong>Ch·ªß ƒë·ªÅ #${thread.id}</strong></div>
            <div>Lo·∫°i: ${thread.type}</div>
            ${thread.courseId ? `<div>Kh√≥a h·ªçc: ${thread.courseId}</div>` : ''}
            ${thread.lessonId ? `<div>B√†i h·ªçc: ${thread.lessonId}</div>` : ''}
            <div>S·ªë b√†i vi·∫øt: ${thread._count.posts}</div>
            <div class="timestamp">T·∫°o l√∫c: ${new Date(thread.createdAt).toLocaleString()}</div>
          `;

          div.addEventListener('click', () => {
            document
              .querySelectorAll('.thread')
              .forEach((el) => el.classList.remove('active-thread'));
            div.classList.add('active-thread');
            currentThreadId = thread.id;
            currentPage = 1;
            document.getElementById('thread-title').textContent =
              `Ch·ªß ƒë·ªÅ #${thread.id}`;
            fetchPosts(thread.id);
          });
          threadListDiv.appendChild(div);
        });
      }

      // L·∫•y danh s√°ch posts cho thread
      async function fetchPosts(threadId, page = 1) {
        try {
          const response = await fetch(
            `${BASE_URL}/posts/thread/${threadId}?page=${page}&limit=${POSTS_PER_PAGE}`,
          );
          if (!response.ok) throw new Error('L·ªói khi l·∫•y danh s√°ch b√¨nh lu·∫≠n');

          const responseData = await response.json();
          await renderPosts(responseData.data);
          updatePagination(responseData.meta);
        } catch (error) {
          console.error(error);
          document.getElementById('post-list').innerHTML =
            '<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c b√¨nh lu·∫≠n.</p>';
        }
      }

      // Ki·ªÉm tra tr·∫°ng th√°i like c·ªßa post
      async function checkLikeStatus(postId) {
        try {
          const response = await fetch(
            `${BASE_URL}/posts/${postId}/likes/check?userId=${MOCK_USER_ID}`,
          );
          if (!response.ok) throw new Error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i like');

          const { hasLiked } = await response.json();
          return hasLiked;
        } catch (error) {
          console.error(error);
          return false;
        }
      }

      // L·∫•y s·ªë l∆∞·ª£ng like c·ªßa post
      async function getLikeCount(postId) {
        try {
          const response = await fetch(
            `${BASE_URL}/posts/${postId}/likes/count`,
          );
          if (!response.ok) throw new Error('L·ªói khi l·∫•y s·ªë l∆∞·ª£ng like');

          const { count } = await response.json();
          return count;
        } catch (error) {
          console.error(error);
          return 0;
        }
      }

      // Toggle like post
      async function toggleLike(postId, likeButton) {
        try {
          const isLiked = likeButton.classList.contains('liked');
          const method = isLiked ? 'DELETE' : 'POST';

          const response = await fetch(`${BASE_URL}/posts/${postId}/likes`, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: MOCK_USER_ID }),
          });

          if (!response.ok) throw new Error('L·ªói khi th·ª±c hi·ªán like/unlike');

          // Update UI
          likeButton.classList.toggle('liked');
          const countSpan = likeButton.nextElementSibling;
          const currentCount = parseInt(countSpan.textContent);
          countSpan.textContent = isLiked ? currentCount - 1 : currentCount + 1;
        } catch (error) {
          console.error(error);
          alert('C√≥ l·ªói khi th·ª±c hi·ªán like/unlike');
        }
      }

      // Render posts
      async function renderPosts(posts) {
        const postListDiv = document.getElementById('post-list');
        postListDiv.innerHTML = '';

        if (!posts || posts.length === 0) {
          postListDiv.innerHTML = '<p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>';
          return;
        }

        for (const post of posts) {
          const postDiv = document.createElement('div');
          postDiv.className = 'post';

          const hasLiked = await checkLikeStatus(post.id);
          const likeCount = await getLikeCount(post.id);

          postDiv.innerHTML = `
            <div class="author">${post.authorId || '·∫®n danh'}</div>
            <div class="content">${post.content}</div>
            ${post.rating ? `<div class="rating">ƒê√°nh gi√°: ${post.rating}/5</div>` : ''}
            <div class="timestamp">${new Date(post.createdAt).toLocaleString()}</div>
            <div class="actions">
              <button class="like-btn ${hasLiked ? 'liked' : ''}" onclick="toggleLike(${post.id}, this)">
                ${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'} Th√≠ch
              </button>
              <span class="like-count">${likeCount}</span>
              <button class="reply-btn" onclick="toggleReplyForm(${post.id})">Tr·∫£ l·ªùi</button>
            </div>
            <div class="reply-form" id="reply-form-${post.id}">
              <textarea placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..."></textarea>
              <button onclick="submitReply(${post.id})">G·ª≠i</button>
            </div>
            <div class="replies" id="replies-${post.id}"></div>
          `;

          postListDiv.appendChild(postDiv);

          // Fetch and render replies
          if (!post.parentId) {
            await fetchReplies(post.id);
          }
        }
      }

      // Toggle reply form
      function toggleReplyForm(postId) {
        const form = document.getElementById(`reply-form-${postId}`);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
      }

      // Submit reply
      async function submitReply(parentPostId) {
        const form = document.getElementById(`reply-form-${parentPostId}`);
        const content = form.querySelector('textarea').value.trim();

        if (!content) {
          alert('Vui l√≤ng nh·∫≠p n·ªôi dung tr·∫£ l·ªùi');
          return;
        }

        try {
          const response = await fetch(
            `${BASE_URL}/posts/thread/${currentThreadId}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                content,
                authorId: MOCK_USER_ID,
                parentId: parentPostId,
              }),
            },
          );

          if (!response.ok) throw new Error('G·ª≠i tr·∫£ l·ªùi th·∫•t b·∫°i');

          form.querySelector('textarea').value = '';
          form.style.display = 'none';
          await fetchPosts(currentThreadId, currentPage);
        } catch (error) {
          console.error(error);
          alert('C√≥ l·ªói khi g·ª≠i tr·∫£ l·ªùi');
        }
      }

      // Fetch replies
      async function fetchReplies(parentPostId) {
        try {
          const response = await fetch(
            `${BASE_URL}/posts/thread/${currentThreadId}?parentId=${parentPostId}`,
          );
          if (!response.ok) throw new Error('L·ªói khi l·∫•y danh s√°ch tr·∫£ l·ªùi');

          const responseData = await response.json();
          const repliesDiv = document.getElementById(`replies-${parentPostId}`);

          for (const reply of responseData.data) {
            const replyDiv = document.createElement('div');
            replyDiv.className = 'post';

            const hasLiked = await checkLikeStatus(reply.id);
            const likeCount = await getLikeCount(reply.id);

            replyDiv.innerHTML = `
              <div class="author">${reply.authorId || '·∫®n danh'}</div>
              <div class="content">${reply.content}</div>
              <div class="timestamp">${new Date(reply.createdAt).toLocaleString()}</div>
              <div class="actions">
                <button class="like-btn ${hasLiked ? 'liked' : ''}" onclick="toggleLike(${reply.id}, this)">
                  ${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'} Th√≠ch
                </button>
                <span class="like-count">${likeCount}</span>
              </div>
            `;

            repliesDiv.appendChild(replyDiv);
          }
        } catch (error) {
          console.error(error);
        }
      }

      // Update pagination
      function updatePagination(meta) {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');

        prevBtn.disabled = meta.page === 1;
        nextBtn.disabled = meta.page >= meta.totalPages;
        pageInfo.textContent = `Trang ${meta.page} / ${meta.totalPages}`;

        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            fetchPosts(currentThreadId, currentPage);
          }
        };

        nextBtn.onclick = () => {
          if (currentPage < meta.totalPages) {
            currentPage++;
            fetchPosts(currentThreadId, currentPage);
          }
        };
      }

      // Create new thread
      async function createThread() {
        const type = document.getElementById('thread-type').value;
        const courseId = document.getElementById('course-id').value;
        const lessonId = document.getElementById('lesson-id').value;
        const content = document
          .getElementById('new-thread-content')
          .value.trim();
        const rating = document.getElementById('initial-rating').value;

        if (!content) {
          alert('Vui l√≤ng nh·∫≠p n·ªôi dung');
          return;
        }

        // Validate required fields based on thread type
        if (type === 'LESSON_DISCUSSION' && !lessonId) {
          alert('Vui l√≤ng nh·∫≠p ID b√†i h·ªçc cho ch·ªß ƒë·ªÅ th·∫£o lu·∫≠n');
          return;
        }
        if (type === 'COURSE_REVIEW' && !courseId) {
          alert('Vui l√≤ng nh·∫≠p ID kh√≥a h·ªçc cho ƒë√°nh gi√°');
          return;
        }
        if (type === 'COURSE_REVIEW' && (!rating || rating < 1 || rating > 5)) {
          alert('Vui l√≤ng nh·∫≠p ƒë√°nh gi√° t·ª´ 1-5 sao cho ƒë√°nh gi√° kh√≥a h·ªçc');
          return;
        }

        const payload = {
          type,
          ...(courseId && { courseId }),
          ...(lessonId && { lessonId }),
          initialPost: {
            content,
            authorId: MOCK_USER_ID,
            ...(rating && { rating: parseInt(rating) }),
          },
        };

        try {
          const response = await fetch(`${BASE_URL}/threads/create`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => null);
            throw new Error(errorData?.message || 'T·∫°o ch·ªß ƒë·ªÅ th·∫•t b·∫°i');
          }

          alert('Ch·ªß ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c t·∫°o!');
          // Reset form
          document.getElementById('course-id').value = '';
          document.getElementById('lesson-id').value = '';
          document.getElementById('new-thread-content').value = '';
          document.getElementById('initial-rating').value = '';
          await fetchThreads();
        } catch (error) {
          console.error(error);
          alert(error.message || 'C√≥ l·ªói khi t·∫°o ch·ªß ƒë·ªÅ');
        }
      }

      // Event listeners
      document
        .getElementById('create-thread-btn')
        .addEventListener('click', createThread);
      document
        .getElementById('thread-type')
        .addEventListener('change', fetchThreads);

      // Initial load
      fetchThreads();
    </script>
  </body>
</html>
